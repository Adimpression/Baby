(function (b) {
    b.prompt = function (r, a) {
        a = b.extend({}, b.prompt.defaults, a);
        b.prompt.currentPrefix = a.prefix;
        var C = (b.browser.msie && b.browser.version < 7);
        var A = b(document.body);
        var E = b(window);
        var F = '<div class="' + a.prefix + 'box" id="' + a.prefix + 'box">';
        if (a.useiframe && ((b("object, applet").length > 0) || C)) {
            F += '<iframe src="javascript:false;" style="display:block;position:absolute;z-index:-1;" class="' + a.prefix + 'fade" id="' + a.prefix + 'fade"></iframe>'
        } else {
            if (C) {
                b("select").css("visibility", "hidden")
            }
            F += '<div class="' + a.prefix + 'fade" id="' + a.prefix + 'fade"></div>'
        }
        F += '<div class="' + a.prefix + '" id="' + a.prefix + '"><div class="' + a.prefix + 'container"><div class="';
        F += a.prefix + 'close">X</div><div id="' + a.prefix + 'states"></div>';
        F += "</div></div></div>";
        var s = b(F).appendTo(A);
        var v = s.children("#" + a.prefix);
        var u = s.children("#" + a.prefix + "fade");
        if (r.constructor == String) {
            r = {state0: {html: r, buttons: a.buttons, focus: a.focus, submit: a.submit}}
        }
        var t = "";
        b.each(r, function (c, d) {
            d = b.extend({}, b.prompt.defaults.state, d);
            r[c] = d;
            t += '<div id="' + a.prefix + "_state_" + c + '" class="' + a.prefix + '_state" style="display:none;"><div class="' + a.prefix + 'message">' + d.html + '</div><div class="' + a.prefix + 'buttons">';
            b.each(d.buttons, function (e, f) {
                t += '<button name="' + a.prefix + "_" + c + "_button" + e + '" id="' + a.prefix + "_" + c + "_button" + e + '" value="' + f + '">' + e + "</button>"
            });
            t += "</div></div>"
        });
        v.find("#" + a.prefix + "states").html(t).children("." + a.prefix + "_state:first").css("display", "block");
        v.find("." + a.prefix + "buttons:empty").css("display", "none");
        b.each(r, function (c, d) {
            var e = v.find("#" + a.prefix + "_state_" + c);
            e.children("." + a.prefix + "buttons").children("button").click(function () {
                var g = e.children("." + a.prefix + "message");
                var i = d.buttons[b(this).text()];
                var f = {};
                b.each(v.find("#" + a.prefix + "states :input").serializeArray(), function (k, j) {
                    if (f[j.name] === undefined) {
                        f[j.name] = j.value
                    } else {
                        if (typeof f[j.name] == Array) {
                            f[j.name].push(j.value)
                        } else {
                            f[j.name] = [f[j.name], j.value]
                        }
                    }
                });
                var h = d.submit(i, g, f);
                if (h === undefined || h) {
                    D(true, i, g, f)
                }
            });
            e.find("." + a.prefix + "buttons button:eq(" + d.focus + ")").addClass(a.prefix + "defaultbutton")
        });
        var B = function () {
            s.css({top: E.scrollTop()})
        };
        var x = function () {
            if (a.persistent) {
                var c = 0;
                s.addClass(a.prefix + "warning");
                var d = setInterval(function () {
                    s.toggleClass(a.prefix + "warning");
                    if (c++ > 1) {
                        clearInterval(d);
                        s.removeClass(a.prefix + "warning")
                    }
                }, 100)
            } else {
                D()
            }
        };
        var z = function (d) {
            var e = (window.event) ? event.keyCode : d.keyCode;
            if (e == 27) {
                D()
            }
            if (e == 9) {
                var c = b(":input:enabled:visible", s);
                var f = !d.shiftKey && d.target == c[c.length - 1];
                var g = d.shiftKey && d.target == c[0];
                if (f || g) {
                    setTimeout(function () {
                        if (!c) {
                            return
                        }
                        var h = c[g === true ? c.length - 1 : 0];
                        if (h) {
                            h.focus()
                        }
                    }, 10);
                    return false
                }
            }
        };
        var y = function () {
            s.css({position: (C) ? "absolute" : "fixed", height: E.height(), width: "100%", top: (C) ? E.scrollTop() : 0, left: 0, right: 0, bottom: 0});
            u.css({position: "absolute", height: E.height(), width: "100%", top: 0, left: 0, right: 0, bottom: 0});
            v.css({position: "absolute", top: a.top, left: "50%", marginLeft: ((v.outerWidth() / 2) * -1)})
        };
        var w = function () {
            u.css({zIndex: a.zIndex, display: "none", opacity: a.opacity});
            v.css({zIndex: a.zIndex + 1, display: "none"});
            s.css({zIndex: a.zIndex})
        };
        var D = function (d, e, c, f) {
            v.remove();
            if (C) {
                A.unbind("scroll", B)
            }
            E.unbind("resize", y);
            u.fadeOut(a.overlayspeed, function () {
                u.unbind("click", x);
                u.remove();
                if (d) {
                    a.callback(e, c, f)
                }
                s.unbind("keypress", z);
                s.remove();
                if (C && !a.useiframe) {
                    b("select").css("visibility", "visible")
                }
            })
        };
        y();
        w();
        if (C) {
            E.scroll(B)
        }
        u.click(x);
        E.resize(y);
        s.bind("keydown keypress", z);
        v.find("." + a.prefix + "close").click(D);
        u.fadeIn(a.overlayspeed);
        v[a.show](a.promptspeed, a.loaded);
        if (a.timeout > 0) {
            setTimeout(b.prompt.close, a.timeout)
        }
        return v.find("#" + a.prefix + "states ." + a.prefix + "_state:first ." + a.prefix + "defaultbutton").focus()
    };
    b.prompt.defaults = {prefix: "jqi", buttons: {Ok: true}, loaded: function () {
    }, submit: function () {
        return true
    }, callback: function () {
    }, opacity: 0.6, zIndex: 999, overlayspeed: "slow", promptspeed: "fast", show: "fadeIn", focus: 0, useiframe: false, top: "15%", persistent: true, timeout: 0, state: {html: "", buttons: {Ok: true}, focus: 0, submit: function () {
        return true
    }}};
    b.prompt.currentPrefix = b.prompt.defaults.prefix;
    b.prompt.setDefaults = function (a) {
        b.prompt.defaults = b.extend({}, b.prompt.defaults, a)
    };
    b.prompt.setStateDefaults = function (a) {
        b.prompt.defaults.state = b.extend({}, b.prompt.defaults.state, a)
    };
    b.prompt.getStateContent = function (a) {
        return b("#" + b.prompt.currentPrefix + "_state_" + a)
    };
    b.prompt.getCurrentState = function () {
        return b("." + b.prompt.currentPrefix + "_state:visible")
    };
    b.prompt.getCurrentStateName = function () {
        var a = b.prompt.getCurrentState().attr("id");
        return a.replace(b.prompt.currentPrefix + "_state_", "")
    };
    b.prompt.goToState = function (a) {
        b("." + b.prompt.currentPrefix + "_state").slideUp("slow");
        b("#" + b.prompt.currentPrefix + "_state_" + a).slideDown("slow", function () {
            b(this).find("." + b.prompt.currentPrefix + "defaultbutton").focus()
        })
    };
    b.prompt.nextState = function () {
        var a = b("." + b.prompt.currentPrefix + "_state:visible").next();
        b("." + b.prompt.currentPrefix + "_state").slideUp("slow");
        a.slideDown("slow", function () {
            a.find("." + b.prompt.currentPrefix + "defaultbutton").focus()
        })
    };
    b.prompt.prevState = function () {
        var a = b("." + b.prompt.currentPrefix + "_state:visible").prev();
        b("." + b.prompt.currentPrefix + "_state").slideUp("slow");
        a.slideDown("slow", function () {
            a.find("." + b.prompt.currentPrefix + "defaultbutton").focus()
        })
    };
    b.prompt.close = function () {
        b("#" + b.prompt.currentPrefix + "box").fadeOut("fast", function () {
            b(this).remove()
        })
    }
})(jQuery);
